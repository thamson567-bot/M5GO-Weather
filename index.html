from m5stack import *
from m5ui import *
from uiflow import *
import wifiCfg
import ntptime
import unit
import socket
import gc
import math
import _thread
import time

setScreenColor(0x222222)
env3_1 = unit.get(unit.ENV3, unit.PORTA)
angle_1 = unit.get(unit.ANGLE, unit.PORTB)
rgb_1 = unit.get(unit.RGB, unit.PORTC)

i = None
last_i = None
j = None
last_pressure = None
wifi_connected = None
ntp = None
counter = None

# NEW: Room control variables
control_mode = 0  # 0 = Total Control, 1 = Individual Room
selected_room = 1  # Which room (1, 2, or 3)
room1_level = 0   # M5Stack LED
room2_level = 0   # RGB LED
room3_level = 0   # Arduino Mega
manual_override = False  # NEW: Track if user manually set lights

wifiCfg.reconnect()
wifiCfg.doConnect('Linksys32906', 'Aa98722580')

label3 = M5TextBox(210, 91, "Fri", lcd.FONT_DejaVu24, 0xffffff, rotate=0)
rectangle0 = M5Rect(16, 130, 80, 50, 0x383333, 0x383333)
rectangle1 = M5Rect(105, 130, 80, 50, 0x383333, 0x383333)
rectangle2 = M5Rect(195, 130, 110, 50, 0x383333, 0x383333)
circle1 = M5Circle(116, 213, 5, 0xFFFFFF, 0xFFFFFF)
circle2 = M5Circle(144, 213, 5, 0xFFFFFF, 0xFFFFFF)
circle3 = M5Circle(174, 213, 5, 0xFFFFFF, 0xFFFFFF)
circle4 = M5Circle(203, 213, 5, 0xFFFFFF, 0xFFFFFF)
Forward = M5TextBox(222, 224, "Forward", lcd.FONT_Default, 0xFFFFFF, rotate=0)
label5 = M5TextBox(45, 224, "Back", lcd.FONT_Default, 0xFFFFFF, rotate=0)
label8 = M5TextBox(139, 224, "Home", lcd.FONT_Default, 0xFFFFFF, rotate=0)
label9 = M5TextBox(42, 134, "Temp", lcd.FONT_DefaultSmall, 0xffc400, rotate=0)
label10 = M5TextBox(128, 134, "Humid", lcd.FONT_DefaultSmall, 0x24c7ff, rotate=0)
label11 = M5TextBox(230, 134, "Pressure", lcd.FONT_DefaultSmall, 0xf8ff00, rotate=0)
label0 = M5TextBox(110, 150, "Text", lcd.FONT_DejaVu18, 0xFFFFFF, rotate=0)
label7 = M5TextBox(34, 28, "16:52:23", lcd.FONT_DejaVu56, 0xFFFFFF, rotate=0)
label6 = M5TextBox(34, 91, "2026-01-22", lcd.FONT_DejaVu24, 0xFFFFFF, rotate=0)
label2 = M5TextBox(20, 150, "Text", lcd.FONT_DejaVu18, 0xFFFFFF, rotate=0)
label4 = M5TextBox(200, 150, "Text", lcd.FONT_DejaVu18, 0xFFFFFF, rotate=0)
label1 = M5TextBox(268, 0, "Text", lcd.FONT_DejaVu18, 0xffffff, rotate=0)
cloud_label = M5TextBox(10, 210, "", lcd.FONT_DefaultSmall, 0x00FF00, rotate=0)

from numbers import Number

THINGSPEAK_KEY = 'W0R5AL9YS3DDDJHL'
CHANNEL_ID = '3260324'

send_ok = 0
send_fail = 0
cloud_status = 'Ready'
cloud_color = 0x00FF00

sensor_temp = 25.0
sensor_humid = 50.0
sensor_pressure = 1013.0
sensor_angle = 0
sensor_dew = 0.0
sensor_heat = 25.0


def cloud_thread():
    """Background thread that sends data to ThingSpeak every 15 seconds"""
    global send_ok, send_fail, cloud_status, cloud_color
    global sensor_temp, sensor_humid, sensor_pressure, sensor_angle
    global room1_level, room2_level, room3_level

    while True:
        try:
            time.sleep(15)

            if not wifiCfg.wlan_sta.isconnected():
                cloud_status = 'No WiFi'
                cloud_color = 0xFF0000
                continue

            s = None
            try:
                t = sensor_temp
                h = sensor_humid
                p = sensor_pressure
                a = sensor_angle

                # Dew point calculation
                try:
                    al = (17.27 * t) / (237.7 + t) + math.log(h / 100.0) if h > 0 else 0
                    dp = round((237.7 * al) / (17.27 - al), 1)
                except:
                    dp = 0

                # Heat index calculation
                if t >= 20:
                    hi = round(t + 0.33 * (h / 100.0 * 6.105 * (17.27 * t / (237.7 + t))) - 4.0, 1)
                else:
                    hi = t

                # NEW: Send individual room levels
                path = '/update?api_key=' + THINGSPEAK_KEY
                path += '&field1=' + str(t)
                path += '&field2=' + str(h)
                path += '&field3=' + str(p)
                path += '&field4=' + str(room1_level)  # Room 1 (M5Stack)
                path += '&field5=' + str(room2_level)  # Room 2 (RGB LED)
                path += '&field6=' + str(room3_level)  # Room 3 (Arduino Mega)

                addr = socket.getaddrinfo('api.thingspeak.com', 80)[0][-1]
                s = socket.socket()
                s.settimeout(5)
                s.connect(addr)

                req = 'GET ' + path + ' HTTP/1.1\r\n'
                req += 'Host: api.thingspeak.com\r\n'
                req += 'Connection: close\r\n\r\n'
                s.send(req.encode())

                resp = s.recv(256)
                s.close()

                send_ok += 1
                cloud_status = 'OK:' + str(send_ok)
                cloud_color = 0x00FF00

                gc.collect()

            except Exception as e:
                send_fail += 1
                cloud_status = 'FAIL:' + str(send_fail)
                cloud_color = 0xFF0000
                if s:
                    try:
                        s.close()
                    except:
                        pass

        except Exception as e:
            pass


def buttonA_wasPressed():
    global i, last_i, control_mode, selected_room
    
    if i == 0:
        # Home screen - go back
        if i > 0:
            last_i = i
            i = (i if isinstance(i, Number) else 0) + -1
    elif i == 4:
        # Lighting page - toggle mode
        control_mode = 1 - control_mode
    else:
        # Other pages - go back
        if i > 0:
            last_i = i
            i = (i if isinstance(i, Number) else 0) + -1


btnA.wasPressed(buttonA_wasPressed)


def buttonB_wasPressed():
    global i, last_i, selected_room, control_mode, manual_override
    
    if i == 4 and control_mode == 1:
        # Lighting page in individual mode - cycle rooms
        selected_room = (selected_room % 3) + 1
    else:
        # Go home - reset manual override when leaving lighting page
        if i == 4:
            manual_override = False
        i = 0


btnB.wasPressed(buttonB_wasPressed)


def buttonC_wasPressed():
    global i, last_i, room1_level, room2_level, room3_level, control_mode, selected_room, manual_override
    
    if i == 4:
        # Lighting page - adjust brightness
        manual_override = True  # User is manually controlling lights
        
        if control_mode == 0:
            # Total control - all rooms
            room1_level = (room1_level + 25) % 125
            room2_level = (room2_level + 25) % 125
            room3_level = (room3_level + 25) % 125
            if room1_level > 100:
                room1_level = 0
                room2_level = 0
                room3_level = 0
        else:
            # Individual room control
            if selected_room == 1:
                room1_level = (room1_level + 25) % 125
                if room1_level > 100:
                    room1_level = 0
            elif selected_room == 2:
                room2_level = (room2_level + 25) % 125
                if room2_level > 100:
                    room2_level = 0
            elif selected_room == 3:
                room3_level = (room3_level + 25) % 125
                if room3_level > 100:
                    room3_level = 0
        
        update_physical_lights()
    else:
        # Navigate forward
        if i < 4:
            last_i = i
            i = (i if isinstance(i, Number) else 0) + 1


btnC.wasPressed(buttonC_wasPressed)


def update_physical_lights():
    """Update physical RGB LED based on room2_level"""
    global room2_level
    
    rgb_1.setBrightness(room2_level)
    rgb.setBrightness(room2_level)
    
    if room2_level == 0:
        rgb_1.setColorAll(0x000000)
        rgb.setColorAll(0x000000)
    elif room2_level <= 25:
        rgb_1.setColorAll(0xffff99)
        rgb.setColorAll(0xffff99)
    elif room2_level <= 50:
        rgb_1.setColorAll(0xffffaa)
        rgb.setColorAll(0xffffaa)
    elif room2_level <= 75:
        rgb_1.setColorAll(0x99ffff)
        rgb.setColorAll(0x99ffff)
    else:
        rgb_1.setColorAll(0xffffff)
        rgb.setColorAll(0xffffff)


label0.hide()
label2.hide()
label4.hide()
label6.hide()
label7.hide()
label3.hide()
j = 10
i = 0
counter = 0
last_pressure = env3_1.pressure

try:
    wifi_connected = wifiCfg.wlan_sta.isconnected()
except:
    wifi_connected = False

if wifiCfg.wlan_sta.isconnected():
    try:
        ntp = ntptime.client(host='cn.pool.ntp.org', timezone=8)
    except:
        ntp = None
        wifi_connected = False

gc.collect()

if wifi_connected:
    _thread.start_new_thread(cloud_thread, ())
    cloud_status = 'Starting...'

# Main UI loop
while True:
    sensor_temp = round(env3_1.temperature, 1)
    sensor_humid = round(env3_1.humidity, 1)
    sensor_pressure = round(env3_1.pressure / 100, 1)
    sensor_angle = angle_1.read()

    if last_i != i:
        if i == 0:
            # HOME PAGE
            lcd.clear()
            label7.setFont(lcd.FONT_DejaVu56)
            label7.setPosition(34, 28)
            label6.setPosition(34, 91)
            label3.setPosition(213, 91)
            rectangle0.show()
            rectangle1.show()
            rectangle2.show()
            label3.setColor(0xffffff)
            circle1.setBgColor(0xff0000)
            circle2.setBgColor(0xffffff)
            circle3.setBgColor(0xffffff)
            circle4.setBgColor(0xffffff)
            circle1.show()
            circle2.show()
            circle3.show()
            circle4.show()
            label0.show()
            label2.show()
            label4.show()
            label1.show()
            label6.show()
            label7.show()
            label3.show()
            label9.show()
            label10.show()
            label11.show()
            label5.show()
            Forward.show()
            label8.show()
            cloud_label.show()
            last_i = i
            
        elif i == 1:
            # TEMPERATURE PAGE
            lcd.clear()
            label7.setFont(lcd.FONT_DejaVu56)
            label7.setPosition(70, 91)
            label6.setPosition(34, 35)
            label3.setPosition(20, 170)
            label6.setText('Temperature')
            circle2.setBgColor(0xff0000)
            circle1.setBgColor(0xffffff)
            circle3.setBgColor(0xffffff)
            circle4.setBgColor(0xffffff)
            circle1.show()
            circle2.show()
            circle3.show()
            circle4.show()
            label3.show()
            label5.show()
            Forward.show()
            label8.show()
            cloud_label.show()
            if sensor_temp < 18:
                label3.setColor(0x33ccff)
                label3.setText('Cold')
            elif sensor_temp < 25:
                label3.setColor(0x33cc00)
                label3.setText('Comfortable')
            else:
                label3.setColor(0xff0000)
                label3.setText('Warm')
            last_i = i
            
        elif i == 2:
            # HUMIDITY PAGE
            lcd.clear()
            label6.setText('Humidity')
            label7.setText('70.3%')
            label3.setPosition(20, 170)
            label7.setPosition(70, 91)
            circle3.setBgColor(0xff0000)
            circle1.setBgColor(0xffffff)
            circle2.setBgColor(0xffffff)
            circle4.setBgColor(0xffffff)
            circle1.show()
            circle2.show()
            circle3.show()
            circle4.show()
            label3.show()
            label5.show()
            label8.show()
            Forward.show()
            cloud_label.show()
            if sensor_humid < 30:
                label3.setColor(0x999999)
                label3.setText('Dry')
            elif sensor_humid < 60:
                label3.setColor(0x33cc00)
                label3.setText('Comfortable')
            else:
                label3.setColor(0x33ccff)
                label3.setText('Humid')
            last_i = i
            
        elif i == 3:
            # PRESSURE PAGE
            lcd.clear()
            label7.setFont(lcd.FONT_DejaVu56)
            label7.setPosition(10, 91)
            label3.setPosition(20, 170)
            label6.setText('Air Pressure')
            circle4.setBgColor(0xff0000)
            circle1.setBgColor(0xffffff)
            circle2.setBgColor(0xffffff)
            circle3.setBgColor(0xffffff)
            circle1.show()
            circle2.show()
            circle3.show()
            circle4.show()
            label5.show()
            label3.show()
            Forward.show()
            label8.show()
            cloud_label.show()
            if (env3_1.pressure) - last_pressure < -300:
                label3.setColor(0xff0000)
                label3.setText('Rain Likely')
            elif (env3_1.pressure) - last_pressure > 300:
                label3.setColor(0x33ccff)
                label3.setText('Clear Skies')
            else:
                label3.setColor(0xffff00)
                label3.setText('Stable Weather')
            last_i = i
            
        elif i == 4:
            # NEW: LIGHTING CONTROL PAGE
            lcd.clear()
            label6.setFont(lcd.FONT_DejaVu24)
            label6.setPosition(80, 10)
            label6.setText('Lighting')
            label6.setColor(0xFFFF00)
            
            # Mode display
            label7.setFont(lcd.FONT_Default)
            label7.setPosition(10, 45)
            if control_mode == 0:
                label7.setText('Mode: TOTAL CONTROL')
            else:
                label7.setText('Mode: INDIVIDUAL')
            
            # Room levels
            label2.setFont(lcd.FONT_DejaVu18)
            label2.setPosition(10, 80)
            label2.setColor(0x00FF00)
            label2.setText('Room 1 (M5):  ' + str(room1_level) + '%')
            
            label0.setFont(lcd.FONT_DejaVu18)
            label0.setPosition(10, 110)
            label0.setColor(0x00FFFF)
            label0.setText('Room 2 (RGB): ' + str(room2_level) + '%')
            
            label4.setFont(lcd.FONT_DejaVu18)
            label4.setPosition(10, 140)
            label4.setColor(0xFFAA00)
            label4.setText('Room 3 (Mega): ' + str(room3_level) + '%')
            
            # Selection indicator
            if control_mode == 1:
                label3.setFont(lcd.FONT_Default)
                label3.setPosition(260, 75 + (selected_room - 1) * 30)
                label3.setText('<--')
                label3.setColor(0xFF0000)
                label3.show()
            else:
                label3.hide()
            
            # Instructions
            label5.setPosition(10, 180)
            label5.setText('A:Mode B:Room C:+25%')
            
            label8.setPosition(110, 200)
            label8.setText('Home')
            
            Forward.hide()
            
            label2.show()
            label0.show()
            label4.show()
            label6.show()
            label7.show()
            label5.show()
            label8.show()
            cloud_label.show()
            
            last_i = i

    # Update cloud label
    if cloud_status:
        cloud_label.setColor(cloud_color)
        cloud_label.setText(cloud_status)

    # FIXED: Only auto-sync angle sensor if NOT manually controlled
    if not manual_override:
        if sensor_angle < 200:
            auto_level = 0
        elif sensor_angle < 400:
            auto_level = 25
        elif sensor_angle < 600:
            auto_level = 50
        elif sensor_angle < 800:
            auto_level = 75
        else:
            auto_level = 100
        
        # Auto-update all rooms based on angle
        if i == 0:
            room1_level = auto_level
            room2_level = auto_level
            room3_level = auto_level
            update_physical_lights()
            label1.setText(str(auto_level) + '%')
    else:
        # Manual mode - just show status
        if i == 0:
            label1.setText('M:' + str(room2_level) + '%')

    if counter == 30000:
        last_pressure = env3_1.pressure
        counter = 0

    if i == 0:
        if wifi_connected and ntp:
            label3.setText(str(ntp.weekday()))
            label7.setText(str(ntp.formatTime(':')))
            label6.setText(str(ntp.formatDate('-')))
            label2.setText(str((str(("%.2f" % ((sensor_temp)))) + str('C'))))
            label0.setText(str((str(("%.2f" % ((sensor_humid)))) + str('%'))))
            label4.setText(str((str(("%.1f" % ((sensor_pressure)))) + str('hPa'))))
    elif i == 1:
        label7.setText(str((str(("%.1f" % ((sensor_temp)))) + str('C'))))
    elif i == 2:
        label7.setText(str((str(("%.1f" % ((sensor_humid)))) + str('%'))))
    elif i == 3:
        label7.setText(str((str(("%.1f" % ((sensor_pressure)))) + str('hPa'))))

    counter = (counter if isinstance(counter, Number) else 0) + 1
    wait_ms(2)
