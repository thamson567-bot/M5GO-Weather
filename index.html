<script>
// ... (keep all existing code until updateOfficeLights function)

// NEW: Updated room mapping
// Room 1 (Bottom Left) = M5GO LED (Field 5)
// Room 2 (Bottom Right) = RGB LED (Field 6)
// Room 3 (Top Left) = Arduino Mega (Field 4)

function updateOfficeLights(room1Light, room2Light, room3Light) {
  var bulb2 = $('bulb2');
  var bulb3 = $('bulb3');
  var bulb4 = $('bulb4');
  
  var room1 = $('room1bg');
  var room2 = $('room2bg');
  var room3 = $('room3bg');
  var room4 = $('room4bg');
  
  var status2 = $('status2');
  var status3 = $('status3');
  var status4 = $('status4');
  
  var levelText = $('lightLevelText');
  var statusText = $('lightStatus');
  
  // Reset all
  bulb2.classList.remove('on');
  bulb3.classList.remove('on');
  bulb4.classList.remove('on');
  
  bulb2.style.background = '#333';
  bulb3.style.background = '#333';
  bulb4.style.background = '#333';
  
  room1.style.background = '#2a2a3e';
  room2.style.background = '#2a2a3e';
  room3.style.background = '#2a2a3e';
  room4.style.background = '#2a2a3e';
  
  status2.textContent = 'OFF';
  status3.textContent = 'OFF';
  status4.textContent = 'OFF';
  
  status2.className = 'room-status off';
  status3.className = 'room-status off';
  status4.className = 'room-status off';
  
  // Hide top right room (not used)
  room3.style.display = 'none';
  
  var activeRooms = [];
  
  // Room 1 (Bottom Left) - M5GO LED (bulb3)
  if(room1Light > 0) {
    bulb3.classList.add('on');
    var color = room1Light <= 25 ? '#ffff99' : room1Light <= 50 ? '#ffffaa' : 
                room1Light <= 75 ? '#99ffff' : '#ffffff';
    bulb3.style.background = 'radial-gradient(circle, ' + color + ', #888800)';
    room1.style.background = 'rgba(255, 255, 153, ' + (room1Light/200) + ')';
    status3.textContent = room1Light + '%';
    status3.className = 'room-status lit';
    activeRooms.push('Room 1 (M5GO)');
  }
  
  // Room 2 (Bottom Right) - RGB LED (bulb2)
  if(room2Light > 0) {
    bulb2.classList.add('on');
    var color = room2Light <= 25 ? '#ffff99' : room2Light <= 50 ? '#ffffaa' : 
                room2Light <= 75 ? '#99ffff' : '#ffffff';
    bulb2.style.background = 'radial-gradient(circle, ' + color + ', #888800)';
    room2.style.background = 'rgba(255, 255, 153, ' + (room2Light/200) + ')';
    status2.textContent = room2Light + '%';
    status2.className = 'room-status lit';
    activeRooms.push('Room 2 (RGB)');
  }
  
  // Room 3 (Top Left) - Arduino Mega (bulb4)
  if(room3Light > 0) {
    bulb4.classList.add('on');
    var color = room3Light <= 25 ? '#ffff99' : room3Light <= 50 ? '#ffffaa' : 
                room3Light <= 75 ? '#99ffff' : '#ffffff';
    bulb4.style.background = 'radial-gradient(circle, ' + color + ', #888800)';
    room4.style.background = 'rgba(255, 255, 153, ' + (room3Light/200) + ')';
    status4.textContent = room3Light + '%';
    status4.className = 'room-status lit';
    activeRooms.push('Room 3 (Arduino)');
  }
  
  // Overall status
  var maxLight = Math.max(room1Light, room2Light, room3Light);
  if(activeRooms.length === 0) {
    levelText.textContent = 'OFF (0%)';
    levelText.style.color = '#888';
    statusText.textContent = 'All lights are OFF';
  } else {
    var mode = maxLight === 0 ? 'OFF' : maxLight <= 25 ? 'ECO MODE (25%)' : 
               maxLight <= 50 ? 'NORMAL MODE (50%)' : maxLight <= 75 ? 'BRIGHT MODE (75%)' : 'MAXIMUM (100%)';
    levelText.textContent = mode;
    levelText.style.color = maxLight <= 50 ? '#ffff99' : maxLight <= 75 ? '#ccffff' : '#ffffff';
    statusText.textContent = 'Active: ' + activeRooms.join(', ');
  }
  
  var lightMode = maxLight === 0 ? 'OFF' : maxLight <= 25 ? 'ECO' : 
                  maxLight <= 50 ? 'NORMAL' : maxLight <= 75 ? 'BRIGHT' : 'MAX';
  $('homeLights').textContent = lightMode;
}

function fetchData() {
  var url = 'https://api.thingspeak.com/channels/' + CHANNEL + 
            '/feeds.json?api_key=' + READ_KEY + '&results=30';
  
  fetch(url)
    .then(res => {
      if (!res.ok) throw new Error('HTTP error! status: ' + res.status);
      return res.json();
    })
    .then(d => {
      if(!d.feeds || d.feeds.length === 0) throw new Error('No data feeds available');
      
      fc++;
      var f = d.feeds[d.feeds.length - 1];
      
      var temp = parseFloat(f.field1) || 0;
      var hum = parseFloat(f.field2) || 0;
      var pres = parseFloat(f.field3) || 0;
      var room3Light = parseInt(f.field4) || 0;  // Arduino Mega (Room 3)
      var room1Light = parseInt(f.field5) || 0;  // M5GO LED (Room 1)
      var room2Light = parseInt(f.field6) || 0;  // RGB LED (Room 2)

      historicalData.pressure.push(pres);
      historicalData.temperature.push(temp);
      historicalData.humidity.push(hum);
      historicalData.timestamps.push(new Date().getTime());
      
      if(historicalData.pressure.length > historicalData.maxHistory) {
        historicalData.pressure.shift();
        historicalData.temperature.shift();
        historicalData.humidity.shift();
        historicalData.timestamps.shift();
      }

      $('tv').innerHTML = temp.toFixed(1) + '<span class="un">¬∞C</span>';
      $('hv').innerHTML = hum.toFixed(1) + '<span class="un">%</span>';
      $('pv').innerHTML = pres.toFixed(1) + '<span class="un">hPa</span>';
      
      $('weatherTemp').textContent = temp.toFixed(1);
      if(temp < minTemp) minTemp = temp;
      if(temp > maxTemp) maxTemp = temp;
      $('weatherHi').textContent = maxTemp.toFixed(1);
      $('weatherLo').textContent = minTemp.toFixed(1);
      
      var icon = 'üå§Ô∏è', desc = 'Pleasant';
      if(temp < 10) { icon = '‚ùÑÔ∏è'; desc = 'Very Cold'; }
      else if(temp < 18) { icon = 'üå•Ô∏è'; desc = 'Cold'; }
      else if(temp < 25) { icon = 'üå§Ô∏è'; desc = 'Comfortable'; }
      else if(temp < 30) { icon = 'üåû'; desc = 'Warm'; }
      else { icon = 'üî•'; desc = 'Hot'; }
      
      $('weatherIcon').textContent = icon;
      $('weatherDesc').textContent = desc;
      
      var advancedForecast = getAdvancedForecast(temp, hum, pres);
      $('forecast').innerHTML = advancedForecast.icon + ' ' + advancedForecast.text;
      
      highlightCurrentCondition(advancedForecast.text);
      
      var forecastCard = $('forecast').closest('.cd');
      if(forecastCard) {
        var subtitle = forecastCard.querySelector('.su');
        if(subtitle) {
          subtitle.textContent = advancedForecast.details;
        }
      }
      
      $('homeTemp').innerHTML = temp.toFixed(1) + '¬∞C';
      $('hp').style.left = Math.max(0, Math.min(100, hum)) + '%';
      
      // Pass room lights in correct order: Room1, Room2, Room3
      updateOfficeLights(room1Light, room2Light, room3Light);

      var tempData = [], humData = [], presData = [], lightData = [];
      for(var i = 0; i < d.feeds.length; i++) {
        tempData.push(parseFloat(d.feeds[i].field1) || 0);
        humData.push(parseFloat(d.feeds[i].field2) || 0);
        presData.push(parseFloat(d.feeds[i].field3) || 0);
        // Average of all lights for chart
        var avgLight = Math.round(((parseInt(d.feeds[i].field4) || 0) + 
                                    (parseInt(d.feeds[i].field5) || 0) + 
                                    (parseInt(d.feeds[i].field6) || 0)) / 3);
        lightData.push(avgLight);
      }

      drawChart($('c1'), tempData, '#ff6b6b', '¬∞C', 
                {min:'tempMin', max:'tempMax', avg:'tempAvg', count:'tempCount'});
      drawChart($('c2'), humData, '#4ecdc4', '%', 
                {min:'humMin', max:'humMax', avg:'humAvg', count:'humCount'});
      drawChart($('c3'), presData, '#ffd93d', 'hPa', 
                {min:'presMin', max:'presMax', avg:'presAvg', count:null});
      drawChart($('c4'), lightData, '#ffd93d', '%', 
                {min:'lightMin', max:'lightMax', avg:'lightAvg', count:null});
      
      var presTrend = presData.length > 1 ? presData[presData.length-1] - presData[0] : 0;
      $('presTrend').textContent = presTrend > 0 ? 'üìà Rising' : presTrend < 0 ? 'üìâ Falling' : '‚û°Ô∏è Stable';
      
      var maxLight = Math.max(room1Light, room2Light, room3Light);
      var lMode = maxLight === 0 ? 'OFF' : maxLight <= 25 ? 'ECO' : 
                  maxLight <= 50 ? 'NORMAL' : maxLight <= 75 ? 'BRIGHT' : 'MAX';
      $('lightMode').textContent = lMode;

      $('st').className = 'sd ok';
      $('st2').className = 'sd ok';
      $('st3').className = 'sd ok';
      $('st4').className = 'sd ok';
      $('su').textContent = 'Live ¬∑ Updated ' + fc + ' times';
      $('homeStatus').textContent = 'LIVE';
    })
    .catch(err => {
      console.error('Fetch Error:', err);
      $('st').className = 'sd er';
      $('st2').className = 'sd er';
      $('st3').className = 'sd er';
      $('st4').className = 'sd er';
      $('su').textContent = 'Error: ' + err.message;
      $('homeStatus').textContent = 'ERROR';
    });
}

// ... (rest of code remains the same)
</script>
